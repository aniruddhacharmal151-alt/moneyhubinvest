<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Investment Platform</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #dbeafe 0%, #f8fafc 35%, #eef2ff 100%);
    }
    .glass {
      background: linear-gradient(135deg, rgba(255,255,255,.5), rgba(255,255,255,.25));
      border: 1px solid rgba(255,255,255,.45);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 8px 32px rgba(15, 23, 42, 0.08);
    }
    .plan-card {
      transition: transform .35s ease, box-shadow .35s ease, opacity .4s ease;
      animation: fadeCard .5s ease both;
      position: relative;
      overflow: hidden;
    }
    .plan-card::after {
      content: "";
      position: absolute;
      inset: -30%;
      background: radial-gradient(circle at center, var(--aura, rgba(148,163,184,.2)) 0%, transparent 58%);
      pointer-events: none;
    }
    .plan-card:hover { transform: translateY(-8px); box-shadow: 0 14px 36px rgba(15,23,42,.15); }
    .tap:active { transform: scale(.98); }
    .btn-premium {
      transition: transform .3s ease, box-shadow .3s ease, filter .3s ease;
    }
    .btn-premium:hover { box-shadow: 0 8px 24px rgba(37, 99, 235, 0.25); }
    .btn-premium:active { transform: scale(.97); }
    .lowest { box-shadow: 0 0 0 1px rgba(59,130,246,.35), 0 0 32px rgba(59,130,246,.3); }
    .highest { box-shadow: 0 0 0 1px rgba(245, 158, 11,.45), 0 0 36px rgba(245, 158, 11,.35); }
    .highlight-btn { box-shadow: 0 0 24px rgba(59,130,246,.45); }
    .highlight-btn-gold { box-shadow: 0 0 24px rgba(245, 158, 11,.45); }

    .plans-mobile {
      display: flex;
      gap: 1rem;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      padding-bottom: .25rem;
    }
    .plans-mobile > .plan-card { min-width: 85%; scroll-snap-align: center; }

    .fade-slide-enter { animation: slideFade .4s ease both; }
    @keyframes slideFade { from { opacity: 0; transform: translateY(18px);} to { opacity: 1; transform: translateY(0);} }
    @keyframes fadeCard { from { opacity: 0; transform: translateX(18px);} to { opacity: 1; transform: translateX(0);} }

    @media (min-width: 768px) {
      .plans-mobile { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); overflow: visible; }
      .plans-mobile > .plan-card { min-width: 0; }
      @keyframes fadeCard { from { opacity: 0; } to { opacity: 1; } }
    }

    @media (max-width: 767px) {
      .mobile-sheet { align-items: end; }
      .mobile-sheet > .sheet-card {
        width: 100%;
        border-radius: 1.25rem 1.25rem 0 0;
        max-height: 84vh;
        overflow: auto;
      }
    }
  </style>
</head>
<body class="h-full text-slate-800">
  <div class="min-h-full">
    <nav class="sticky top-0 z-50 border-b border-white/40 glass">
      <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-3">
        <div class="font-bold text-xl">ðŸ’Ž InvestHub</div>
        <div id="guest-actions" class="flex items-center gap-2">
          <button onclick="openModal('auth','login')" class="px-4 py-2 rounded-xl text-blue-700 btn-premium">Login</button>
          <button onclick="openModal('auth','signup')" class="px-4 py-2 rounded-xl bg-blue-600 text-white btn-premium">Sign Up</button>
        </div>
        <div id="user-menu" class="hidden items-center gap-2 md:gap-3">
          <div class="hidden sm:block text-sm glass rounded-xl px-3 py-2">
            <span id="welcome-name" class="font-semibold"></span>
            <span class="mx-1">|</span>
            <span id="wallet-balance" class="font-bold text-emerald-700">â‚¹0</span>
          </div>
          <button onclick="navigate('deposit')" class="px-3 py-2 rounded-xl bg-blue-600 text-white btn-premium tap">Deposit</button>
          <button onclick="navigate('withdraw')" class="px-3 py-2 rounded-xl border border-blue-400 text-blue-700 btn-premium tap">Withdraw</button>
          <button onclick="logout()" class="px-3 py-2 rounded-xl border border-rose-300 text-rose-600 btn-premium tap">Logout</button>
        </div>
      </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8 space-y-8">
      <section id="public-view" class="space-y-5">
        <div>
          <h1 class="text-3xl font-bold">Investment Plans</h1>
          <p class="text-slate-600">Login to activate plans and track live returns.</p>
        </div>
        <div id="public-plan-list" class="plans-mobile"></div>
        <div class="text-center">
          <button id="public-load-more" onclick="loadMorePlans('public')" class="px-5 py-2 rounded-xl glass btn-premium">Load More Plans</button>
        </div>
      </section>

      <section id="dashboard-view" class="hidden space-y-6">
        <div class="glass rounded-2xl p-4 md:p-6">
          <h2 class="text-2xl font-bold">Home Dashboard</h2>
          <p class="text-slate-600">Choose a plan and pay securely with Razorpay.</p>
        </div>

        <section id="home-section" class="space-y-4">
          <div id="private-plan-list" class="plans-mobile"></div>
          <div class="text-center">
            <button id="private-load-more" onclick="loadMorePlans('private')" class="px-5 py-2 rounded-xl glass btn-premium">Load More Plans</button>
          </div>
        </section>

        <section id="deposit-section" class="hidden glass rounded-2xl p-5">
          <h3 class="text-xl font-semibold mb-2">Deposit</h3>
          <p class="text-slate-600">Select any plan card and tap Deposit to proceed via Razorpay.</p>
        </section>

        <section id="withdraw-section" class="hidden glass rounded-2xl p-5 space-y-4">
          <h3 class="text-xl font-semibold">Withdraw</h3>
          <form id="withdraw-form" class="grid md:grid-cols-3 gap-3" onsubmit="handleWithdraw(event)">
            <input id="withdraw-amount" type="number" min="1000" step="100" required placeholder="Amount â‚¹ (min 1000)" class="px-3 py-2 rounded-xl border" />
            <input id="withdraw-upi" type="text" required placeholder="UPI ID" class="px-3 py-2 rounded-xl border" />
            <button class="rounded-xl bg-emerald-600 text-white btn-premium tap">Submit Withdraw</button>
          </form>
          <div id="withdraw-msg" class="text-sm"></div>
          <div>
            <h4 class="font-semibold mb-2">Active & Completed Investments</h4>
            <div id="withdraw-investments" class="space-y-2"></div>
          </div>
        </section>

        <section class="glass rounded-2xl p-5">
          <h3 class="text-xl font-semibold mb-2">Live Investments</h3>
          <div id="active-investments" class="space-y-2"></div>
        </section>
      </section>
    </main>
  </div>

  <div id="auth-modal" class="hidden fixed inset-0 z-50 bg-black/45 backdrop-blur-sm items-center justify-center p-4 mobile-sheet">
    <div class="sheet-card w-full max-w-md glass rounded-2xl p-5 space-y-3">
      <div class="flex items-center justify-between">
        <h3 id="auth-title" class="text-xl font-bold">Login</h3>
        <button onclick="closeModal('auth')">âœ•</button>
      </div>
      <form id="auth-form" onsubmit="submitAuth(event)" class="space-y-3">
        <input id="auth-email" type="email" required placeholder="Email" class="w-full px-3 py-2 rounded-xl border" />
        <input id="auth-password" type="password" required placeholder="Password" class="w-full px-3 py-2 rounded-xl border" />
        <button id="auth-submit" class="w-full rounded-xl bg-blue-600 text-white py-2 btn-premium tap">Login</button>
      </form>
      <button id="auth-switch" onclick="toggleAuthMode()" class="text-blue-700 text-sm"></button>
    </div>
  </div>

  <div id="deposit-modal" class="hidden fixed inset-0 z-50 bg-black/45 backdrop-blur-sm items-center justify-center p-4 mobile-sheet">
    <div class="sheet-card w-full max-w-lg glass rounded-2xl p-5 space-y-4">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold">Activate Investment</h3>
        <button onclick="closeModal('deposit')">âœ•</button>
      </div>
      <div id="deposit-plan-summary" class="rounded-xl bg-white/50 p-3 text-sm"></div>
      <div>
        <p class="font-medium mb-2">Payment Option</p>
        <button onclick="payWithRazorpay()" class="w-full rounded-xl bg-violet-600 text-white py-2 btn-premium tap">Razorpay (UPI / Cards / Wallets)</button>
      </div>
      <div id="deposit-msg" class="text-sm"></div>
    </div>
  </div>

<script>
const { createClient } = supabase;
const supabaseClient = createClient("https://vwsbxvpghoolfqyxyovf.supabase.co", "sb_publishable_ZJcZG3Eg1glLZ1dZp90i-g_vSlo1HKK");

const plans = [
  { id: 1, name: "Starter", amount: 2000, days: 30, dailyReturn: 90, totalReturn: 4700, aura: "rgba(125,211,252,.32)" },
  { id: 2, name: "Silver", amount: 5000, days: 45, dailyReturn: 160, totalReturn: 12200, aura: "rgba(196,181,253,.30)" },
  { id: 3, name: "Gold", amount: 10000, days: 65, dailyReturn: 320, totalReturn: 30800, aura: "rgba(253,224,71,.26)" },
  { id: 4, name: "Emerald", amount: 12000, days: 75, dailyReturn: 390, totalReturn: 41250, aura: "rgba(110,231,183,.30)" },
  { id: 5, name: "Sapphire", amount: 30000, days: 160, dailyReturn: 1080, totalReturn: 202800, aura: "rgba(147,197,253,.28)" },
  { id: 6, name: "Diamond", amount: 40000, days: 230, dailyReturn: 1580, totalReturn: 403400, aura: "rgba(253,186,116,.32)" }
];
let currentUser = null;
let authMode = "login";
let visiblePublicPlans = 3;
let visiblePrivatePlans = 3;
let selectedPlan = null;
let countdownTimer = null;

function formatCurrency(amount) { return new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR", minimumFractionDigits: 0 }).format(amount); }
function formatTime(ms) {
  if (ms <= 0) return "00 : 00 : 00 : 00";
  const sec = Math.floor(ms / 1000);
  const d = Math.floor(sec / 86400);
  const h = Math.floor((sec % 86400) / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = sec % 60;
  return `${String(d).padStart(2, "0")} : ${String(h).padStart(2, "0")} : ${String(m).padStart(2, "0")} : ${String(s).padStart(2, "0")}`;
}

function openModal(type, mode = "login") {
  if (type === "auth") {
    authMode = mode;
    updateAuthModal();
    document.getElementById("auth-modal").classList.remove("hidden");
    document.getElementById("auth-modal").classList.add("flex");
  }
  if (type === "deposit") {
    document.getElementById("deposit-modal").classList.remove("hidden");
    document.getElementById("deposit-modal").classList.add("flex");
  }
}
function closeModal(type) {
  const el = document.getElementById(`${type}-modal`);
  el.classList.add("hidden");
  el.classList.remove("flex");
}
function toggleAuthMode() { authMode = authMode === "login" ? "signup" : "login"; updateAuthModal(); }
function updateAuthModal() {
  document.getElementById("auth-title").textContent = authMode === "login" ? "Login" : "Sign Up";
  document.getElementById("auth-submit").textContent = authMode === "login" ? "Login" : "Create Account";
  document.getElementById("auth-switch").textContent = authMode === "login" ? "Need an account? Sign Up" : "Already have an account? Login";
}

async function submitAuth(e) {
  e.preventDefault();
  const email = document.getElementById("auth-email").value;
  const password = document.getElementById("auth-password").value;
  const res = authMode === "login"
    ? await supabaseClient.auth.signInWithPassword({ email, password })
    : await supabaseClient.auth.signUp({ email, password });

  if (res.error) return alert(res.error.message);
  closeModal("auth");
  navigate("home");
}

async function logout() { await supabaseClient.auth.signOut(); }

function createPlanCard(plan, loggedIn) {
  const isLowest = plan.id === plans[0].id;
  const isHighest = plan.id === plans[plans.length - 1].id;
  const card = document.createElement("div");
  card.className = `plan-card glass rounded-2xl p-4 tap ${isLowest ? "lowest" : ""} ${isHighest ? "highest" : ""}`;
  card.style.setProperty("--aura", plan.aura);
  card.innerHTML = `
    <h4 class="text-lg font-bold">${plan.name}</h4>
    <p class="text-sm text-slate-600 mt-1">${plan.days} Days Cycle</p>
    <div class="mt-3 space-y-1 text-sm">
      <p>Daily Return: <span class="font-semibold">${formatCurrency(plan.dailyReturn)}</span></p>
      <p>Total Return: <span class="font-semibold">${formatCurrency(plan.totalReturn)}</span></p>
      <p>Plan Amount: <span class="font-semibold">${formatCurrency(plan.amount)}</span></p>
    </div>
    <button class="mt-4 w-full rounded-xl py-2 text-white ${isHighest ? "bg-amber-500 highlight-btn-gold" : "bg-blue-600"} ${isLowest ? "highlight-btn" : ""} btn-premium">${loggedIn ? "Deposit" : "Login to Activate"}</button>
  `;
  card.querySelector("button").onclick = () => {
    if (!loggedIn) return openModal("auth", "login");
    selectedPlan = plan;
    document.getElementById("deposit-plan-summary").innerHTML = `
      <div><b>${plan.name}</b> Plan</div>
      <div>Duration: ${plan.days} days</div>
      <div>Amount: ${formatCurrency(plan.amount)}</div>
      <div>Expected Total: ${formatCurrency(plan.totalReturn)}</div>
    `;
    document.getElementById("deposit-msg").textContent = "";
    openModal("deposit");
  };
  return card;
}

function renderPlans() {
  const publicList = document.getElementById("public-plan-list");
  publicList.innerHTML = "";
  plans.slice(0, visiblePublicPlans).forEach(p => publicList.appendChild(createPlanCard(p, false)));
  document.getElementById("public-load-more").classList.toggle("hidden", visiblePublicPlans >= plans.length);

  const privateList = document.getElementById("private-plan-list");
  privateList.innerHTML = "";
  plans.slice(0, visiblePrivatePlans).forEach((p) => {
    const card = createPlanCard(p, true);
    card.classList.add("fade-slide-enter");
    privateList.appendChild(card);
  });
  document.getElementById("private-load-more").classList.toggle("hidden", visiblePrivatePlans >= plans.length);
}

function loadMorePlans(type) {
  if (type === "public") visiblePublicPlans = Math.min(plans.length, visiblePublicPlans + 3);
  if (type === "private") visiblePrivatePlans = Math.min(plans.length, visiblePrivatePlans + 3);
  renderPlans();
}

function navigate(section) {
  document.getElementById("home-section").classList.toggle("hidden", section !== "home");
  document.getElementById("deposit-section").classList.toggle("hidden", section !== "deposit");
  document.getElementById("withdraw-section").classList.toggle("hidden", section !== "withdraw");
  if (section === "withdraw") renderWithdrawInvestments();
}

async function ensureWalletExists() {
  const { data } = await supabaseClient.from("wallet").select("id").eq("user_id", currentUser.id).maybeSingle();
  if (!data) await supabaseClient.from("wallet").insert({ user_id: currentUser.id, balance: 0 });
}

async function loadWallet() {
  if (!currentUser) return;
  const { data } = await supabaseClient.from("wallet").select("balance").eq("user_id", currentUser.id).single();
  document.getElementById("wallet-balance").textContent = formatCurrency(data?.balance || 0);
}

async function payWithRazorpay() {
  if (!selectedPlan || !currentUser) return;
  const options = {
    key: "rzp_test_1DP5mmOlF5G5ag",
    amount: selectedPlan.amount * 100,
    currency: "INR",
    name: "InvestHub",
    description: `${selectedPlan.name} plan activation`,
    handler: async function (response) {
      await confirmInvestment(response.razorpay_payment_id);
    },
    prefill: { email: currentUser.email },
    theme: { color: "#4f46e5" },
    modal: { ondismiss: () => { document.getElementById("deposit-msg").textContent = "Payment cancelled. Please retry."; } }
  };
  try {
    const rzp = new Razorpay(options);
    rzp.on("payment.failed", () => { document.getElementById("deposit-msg").textContent = "Payment failed. Please retry."; });
    rzp.open();
  } catch {
    document.getElementById("deposit-msg").textContent = "Unable to open payment gateway.";
  }
}

async function confirmInvestment(paymentId) {
  const now = Date.now();
  const end = now + selectedPlan.days * 24 * 60 * 60 * 1000;
  const investment = {
    user_id: currentUser.id,
    plan_id: selectedPlan.id,
    amount: selectedPlan.amount,
    start_timestamp: new Date(now).toISOString(),
    end_timestamp: new Date(end).toISOString(),
    status: "active"
  };

  const { error } = await supabaseClient.from("investments").insert(investment);
  if (error) {
    document.getElementById("deposit-msg").textContent = error.message;
    return;
  }
  await supabaseClient.from("transactions").insert({
    user_id: currentUser.id,
    type: "investment",
    amount: selectedPlan.amount,
    status: "success",
    provider: "razorpay",
    reference_id: paymentId
  });
  document.getElementById("deposit-msg").textContent = "Payment successful. Investment activated.";
  closeModal("deposit");
  fetchInvestments();
}

async function fetchInvestments() {
  if (!currentUser) return;
  const { data } = await supabaseClient.from("investments").select("*").eq("user_id", currentUser.id).order("start_timestamp", { ascending: false });
  const list = data || [];
  renderInvestmentTimers(list);
  renderWithdrawInvestments(list);
}

function renderInvestmentTimers(investments = []) {
  const container = document.getElementById("active-investments");
  container.innerHTML = "";
  if (countdownTimer) clearInterval(countdownTimer);

  if (!investments.length) {
    container.innerHTML = '<div class="text-slate-500">No investments yet.</div>';
    return;
  }

  const draw = async () => {
    const now = Date.now();
    container.innerHTML = "";
    for (const inv of investments) {
      const endMs = new Date(inv.end_timestamp).getTime();
      const left = endMs - now;
      if (left <= 0 && inv.status !== "completed") {
        await supabaseClient.from("investments").update({ status: "completed" }).eq("id", inv.id);
        inv.status = "completed";
      }
      const canWithdrawAt = endMs + 86400000;
      const eligible = now >= canWithdrawAt;
      container.innerHTML += `<div class="rounded-xl border border-white/40 bg-white/40 p-3">
        <div class="flex flex-wrap justify-between gap-2">
          <div><b>Plan #${inv.plan_id}</b> â€¢ ${formatCurrency(inv.amount)}</div>
          <div class="text-sm ${inv.status === "completed" ? "text-emerald-700" : "text-blue-700"}">${inv.status === "completed" ? "Completed" : "Active"}</div>
        </div>
        <div class="text-sm mt-1">Timer: ${inv.status === "completed" ? "Completed" : formatTime(left)}</div>
        <div class="text-xs text-slate-600 mt-1">Withdraw ${eligible ? "enabled" : "available 1 day after completion"}</div>
      </div>`;
    }
  };
  draw();
  countdownTimer = setInterval(draw, 1000);
}

async function renderWithdrawInvestments(prefetched) {
  const { data } = prefetched ? { data: prefetched } : await supabaseClient.from("investments").select("*").eq("user_id", currentUser.id).order("start_timestamp", { ascending: false });
  const list = data || [];
  const box = document.getElementById("withdraw-investments");
  const now = Date.now();
  box.innerHTML = list.map(inv => {
    const canWithdraw = now >= (new Date(inv.end_timestamp).getTime() + 86400000);
    return `<div class="rounded-xl bg-white/50 p-3 border border-white/40 text-sm flex justify-between gap-2">
      <span>Plan #${inv.plan_id} â€¢ ${inv.status}</span>
      <span class="${canWithdraw ? "text-emerald-700" : "text-slate-500"}">${canWithdraw ? "Eligible" : "Locked"}</span>
    </div>`;
  }).join("") || '<div class="text-slate-500">No investments found.</div>';
}

async function handleWithdraw(e) {
  e.preventDefault();
  const amount = parseFloat(document.getElementById("withdraw-amount").value);
  const upi = document.getElementById("withdraw-upi").value;
  const msg = document.getElementById("withdraw-msg");
  msg.textContent = "";
  if (!amount || amount < 1000) { msg.textContent = "Minimum withdrawal â‚¹1000"; return; }

  const { data: wallet } = await supabaseClient.from("wallet").select("balance").eq("user_id", currentUser.id).single();
  if (!wallet || wallet.balance < amount) { msg.textContent = "Insufficient balance"; return; }

  const { error } = await supabaseClient.from("withdrawals").insert({ user_id: currentUser.id, amount, upi_id: upi, status: "pending" });
  if (error) { msg.textContent = error.message; return; }

  await supabaseClient.from("transactions").insert({ user_id: currentUser.id, type: "withdrawal", amount, status: "pending", provider: "upi" });
  msg.textContent = "Withdrawal request submitted. Awaiting admin approval.";
  document.getElementById("withdraw-form").reset();
}

supabaseClient.auth.onAuthStateChange(async (_, session) => {
  currentUser = session?.user || null;
  document.getElementById("public-view").classList.toggle("hidden", !!currentUser);
  document.getElementById("dashboard-view").classList.toggle("hidden", !currentUser);
  document.getElementById("guest-actions").classList.toggle("hidden", !!currentUser);
  document.getElementById("user-menu").classList.toggle("hidden", !currentUser);
  document.getElementById("user-menu").classList.toggle("flex", !!currentUser);

  if (currentUser) {
    document.getElementById("welcome-name").textContent = currentUser.email.split("@")[0];
    await ensureWalletExists();
    await loadWallet();
    await fetchInvestments();
    navigate("home");
  } else {
    renderPlans();
    if (countdownTimer) clearInterval(countdownTimer);
  }
});

renderPlans();
</script>
</body>
</html>
